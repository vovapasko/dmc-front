<div class="container-fluid">
    <app-page-title title="Контрагенты" [breadcrumbItems]="breadCrumbItems"></app-page-title>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-2">
                            <form class="form-inline">
                                <div class="form-group mb-2">
                                    <label class="sr-only">Search</label>
                                    <input type="search" class="form-control" placeholder="Поиск..." [(ngModel)]="term"
                                           name="search"/>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-10">
                            <div class="text-md-right">
                                <div class="dropdown float-right" ngbDropdown>
                                    <a
                                            href="javascript: void(0);"
                                            class="dropdown-toggle card-drop arrow-none"
                                            ngbDropdownToggle
                                            aria-expanded="false"
                                    >
                                        <i class="mdi mdi-dots-horizontal m-0 text-muted h3"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right" ngbDropdownMenu>
                                        <!-- item-->
                                        <a href="javascript:void(0);"
                                           class="dropdown-item"
                                           (click)="openModal(createModal)"
                                        >
                                            <i class="mdi mdi-basket mr-1"></i>
                                            Добавить контрагента
                                        </a>
                                        <!-- item-->
                                        <a href="javascript:void(0);"
                                           class="dropdown-item"
                                           (click)="editChecked(); openModal(editModal, true)"
                                        >
                                            <i class="mdi mdi-settings"></i>
                                            Изменить выбранные
                                        </a>
                                        <!-- item-->
                                        <a href="javascript:void(0);"
                                           class="dropdown-item"
                                           (click)="deleteChecked()"
                                        >
                                            <i class="mdi mdi-close"></i>
                                            Удалить выбранные
                                        </a>
                                        <!-- item-->
                                        <a href="javascript:void(0);"
                                           (click)="editChecked(); openModal(addNewFormatModal, true)"
                                           class="dropdown-item"
                                        >
                                            <i class="mdi mdi-plus"></i>
                                            Добавить формат размещения
                                        </a>
                                        <!-- item-->
                                        <a href="javascript:void(0);"
                                           (click)="editChecked(); openModal(deleteFormatModal, true)"
                                           class="dropdown-item">
                                            <i class="mdi mdi-minus"></i>
                                            Удалить формат размещения
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- end col-->
                    </div>

                    <div class="table-responsive">
                        <app-ui-preloader [display]="loading$ | async"></app-ui-preloader>

                        <table class="table table-centered table-borderless table-hover mb-0">
                            <thead class="thead-light">
                            <tr>
                                <th style="width: 20px;">
                                    <div class="custom-control custom-checkbox">
                                        <input
                                                (click)="checkAll()"
                                                [checked]="
                          (checkedContractors$ | async)?.length !== 0 &&
                          (checkedContractors$ | async)?.length === (contractors$ | async)?.length
                        "
                                                type="checkbox"
                                                class="custom-control-input"
                                                id="customCheck"
                                        />
                                        <label class="custom-control-label" for="customCheck">&nbsp;</label>
                                    </div>
                                </th>
                                <th>Название редакции</th>
                                <th>Контактное лицо</th>
                                <th>Номер телефона</th>
                                <th>Email</th>
                                <th>Стоимость</th>
                                <th>Количество размещений</th>
                                <th>Договоренности</th>
                                <th style="width: 82px;">Действия</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr *ngFor="let contractor of contractors$ | async | filter: term; let i = index">
                                <td>
                                    <div class="custom-control custom-checkbox">
                                        <input
                                                type="checkbox"
                                                [checked]="(checkedContractors$ | async).indexOf(contractor) !== -1"
                                                (click)="check(contractor)"
                                                class="custom-control-input"
                                                id="customCheck{{ i }}"
                                        />
                                        <label class="custom-control-label" for="customCheck{{ i }}">&nbsp;</label>
                                    </div>
                                </td>
                                <td>
                                    {{ contractor.editorName }}
                                </td>
                                <td>
                                    {{ contractor.contactPerson }}
                                </td>
                                <td>
                                    {{ contractor.phoneNumber }}
                                </td>
                                <td>
                                    {{ contractor.email }}
                                </td>
                                <td>
                                    <editable (update)="updateField(contractor, 'onePostPrice')">
                                        <ng-template viewMode>
                                            <span>
                                                <i class="mdi mdi-dots-horizontal m-0 text-muted h3"></i>
                                            </span>
                                        </ng-template>
                                        <ng-template editMode>
                                            <div *ngFor="let format of contractor.postformatlistSet; let idx = index;">
                                                <label for="format_one_post_price{{ idx }}">
                                                    {{format.postFormat}}
                                                </label>
                                                <input id="format_one_post_price{{ idx }}"
                                                       type="number"
                                                       class="form-control"
                                                       [formControl]="getControl(format.id, 'onePostPrice')">
                                            </div>
                                        </ng-template>
                                    </editable>
                                </td>
                                <td>
                                    <editable (update)="updateField(contractor, 'newsAmount')">
                                        <ng-template viewMode>
                                            <span>
                                                <i class="mdi mdi-dots-horizontal m-0 text-muted h3"></i>
                                            </span>
                                        </ng-template>
                                        <ng-template editMode>
                                            <div *ngFor="let format of contractor.postformatlistSet; let idx = index;">
                                                <label for="news_format{{ idx }}">
                                                    {{format.postFormat}}
                                                </label>
                                                <input id="news_format{{ idx }}"
                                                       type="number"
                                                       class="form-control"
                                                       [formControl]="getControl(format.id, 'newsAmount')">
                                            </div>
                                        </ng-template>
                                    </editable>
                                </td>
                                <td>
                                    <editable (update)="updateField(contractor, 'arrangedNews')">
                                        <ng-template viewMode>
                                            <span>
                                                <i class="mdi mdi-dots-horizontal m-0 text-muted h3"></i>
                                            </span>
                                        </ng-template>
                                        <ng-template editMode>
                                            <div *ngFor="let format of contractor.postformatlistSet; let idx = index;">
                                                <label for="arranged_news{{ idx }}">
                                                    {{format.postFormat}}
                                                </label>
                                                <input id="arranged_news{{ idx }}"
                                                       type="number"
                                                       class="form-control"
                                                       [formControl]="getControl(format.id, 'arrangedNews')">
                                            </div>
                                        </ng-template>
                                    </editable>
                                </td>
                                <td>
                                    <a
                                            class="action-icon"
                                            id="openEditModal"
                                            href="javascript: void(0);"
                                            role="button"
                                            (click)="selectContractor(contractor); openModal(editModal)"
                                    >
                                        <i class="mdi mdi-square-edit-outline"></i
                                        ></a>
                                    <a
                                            (click)="delete(contractor)"
                                            id="deleteContractor"
                                            href="javascript: void(0);"
                                            role="button"
                                            class="action-icon"
                                    >
                                        <i class="mdi mdi-delete"></i
                                        ></a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <ul class="pagination pagination-rounded justify-content-end my-2">
                        <ngb-pagination
                                [collectionSize]="totalSize$ | async"
                                (pageChange)="onPageChange($event)"
                                [page]="page$ | async"
                                [pageSize]="pageSize$ | async"
                        ></ngb-pagination>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create new contractor modal  -->
<ng-template #createModal role="document" let-modal="close">
    <div class="modal-header bg-dark">
        <h4 class="modal-title text-white">Добавить контрагента</h4>
        <button
                type="button"
                class="close text-white"
                aria-label="Close"
                id="createContractorModal"
                (click)="modal('Cross click')"
        >
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body p-3">
        <div class="text-left">
            <form (ngSubmit)="submitCreateForm()" [formGroup]="createForm">
                <div class="form-group">
                    <label for="editorName">Название редакции</label>
                    <input
                            type="text"
                            formControlName="editorName"
                            class="form-control"
                            [ngClass]="{ 'is-invalid': submitted && cf.editorName.errors }"
                            id="editorName"
                            placeholder="Введите название редакции"
                    />

                    <div *ngIf="submitted && cf.editorName.errors" class="invalid-feedback">
                        <div *ngIf="cf.editorName.errors.required">Название редакции обязательно</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="contactPerson">Контактное лицо</label>
                    <input
                            type="text"
                            formControlName="contactPerson"
                            class="form-control"
                            [ngClass]="{ 'is-invalid': submitted && cf.contactPerson.errors }"
                            id="contactPerson"
                            placeholder="Введите контактное лицо"
                    />

                    <div *ngIf="submitted && cf.contactPerson.errors" class="invalid-feedback">
                        <div *ngIf="cf.contactPerson.errors.required">Контактное лицо обязательно</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="phoneNumber">Номер телефона</label>
                    <input
                            type="text"
                            formControlName="phoneNumber"
                            class="form-control"
                            id="phoneNumber"
                            [ngClass]="{ 'is-invalid': submitted && cf.phoneNumber.errors }"
                    />
                    <span class="font-13 text-muted">e.g "380992314525"</span>
                    <div *ngIf="submitted && cf.phoneNumber.errors" class="invalid-feedback">
                        <div *ngIf="cf.phoneNumber.errors.pattern">Введите корректный номер</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input
                            class="form-control"
                            id="email"
                            [ngClass]="{ 'is-invalid': submitted && cf.email.errors }"
                            placeholder="Введите email"
                            formControlName="email"
                    />
                    <div *ngIf="submitted && cf.email.errors" class="invalid-feedback">
                        <div *ngIf="cf.email.errors.required">Введите корректный email</div>
                    </div>
                </div>

                <div class="text-right">
                    <button type="submit" class="btn btn-success">Сохранить</button>
                    <button type="button" class="btn btn-danger ml-1" (click)="modal('close click')">Отменить</button>
                </div>
            </form>
        </div>
    </div>
</ng-template>

<!-- Add new format modal  -->
<ng-template #addNewFormatModal role="document" let-modal="close">
    <div class="modal-header bg-dark">
        <h4 class="modal-title text-white">Добавить новый формат размещения</h4>
        <button
                type="button"
                class="close text-white"
                aria-label="Close"
                id="addNewFormatModal"
                (click)="modal('Cross click')"
        >
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body p-3">
        <div class="text-left">
            <form (ngSubmit)="addNewFormats()" [formGroup]="createFormatForm">
                <div class="form-group">
                    <label for="postFormat">Название формата</label>
                    <input
                            type="text"
                            formControlName="postFormat"
                            class="form-control"
                            [ngClass]="{ 'is-invalid': submitted && cff.postFormat.errors }"
                            id="postFormat"
                            placeholder="Введите название формата"
                    />

                    <div *ngIf="submitted && cff.postFormat.errors" class="invalid-feedback">
                        <div *ngIf="cff.postFormat.errors.required">Название формата обязательно</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="onePostPrice"> Стоимость </label>
                    <input
                            type="number"
                            formControlName="onePostPrice"
                            class="form-control"
                            [ngClass]="{ 'is-invalid': submitted && cff.onePostPrice.errors }"
                            id="onePostPrice"
                            placeholder="Введите стоимость одного размещения"
                    />

                    <div *ngIf="submitted && cff.onePostPrice.errors" class="invalid-feedback">
                        <div *ngIf="cff.onePostPrice.errors.required">Это поле обязательно для заполнения</div>
                    </div>
                </div>


                <div class="form-group">
                    <label for="newsAmount"> Количество </label>
                    <input
                            type="number"
                            formControlName="newsAmount"
                            class="form-control"
                            [ngClass]="{ 'is-invalid': submitted && cff.newsAmount.errors }"
                            id="newsAmount"
                            placeholder="Введите количество размещений"
                    />

                    <div *ngIf="submitted && cff.newsAmount.errors" class="invalid-feedback">
                        <div *ngIf="cff.newsAmount.errors.required">Это поле обязательно для заполнения</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="arrangedNews"> Договоренность </label>
                    <input
                            type="number"
                            formControlName="arrangedNews"
                            class="form-control"
                            [ngClass]="{ 'is-invalid': submitted && cff.arrangedNews.errors }"
                            id="arrangedNews"
                            placeholder="Введите количество необходимых размещений"
                    />

                    <div *ngIf="submitted && cff.arrangedNews.errors" class="invalid-feedback">
                        <div *ngIf="cff.arrangedNews.errors.required">Это поле обязательно для заполнения</div>
                    </div>
                </div>


                <div class="text-right">
                    <button type="submit" class="btn btn-success">Сохранить</button>
                    <button type="button" class="btn btn-danger ml-1" (click)="modal('close click')">Отменить</button>
                </div>
            </form>
        </div>
    </div>
</ng-template>

<!-- Delete format modal  -->
<ng-template #deleteFormatModal role="document" let-modal="close">
    <div class="modal-header bg-dark">
        <h4 class="modal-title text-white">Удалить формат размещения</h4>
        <button
                type="button"
                class="close text-white"
                aria-label="Close"
                id="deleteFormatModal"
                (click)="modal('Cross click')"
        >
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body p-3">
        <div class="text-left">
            <form (ngSubmit)="deleteFormats()" [formGroup]="deleteFormatForm">
                <div class="form-group row mb-3">
                    <label for="deletePostFormat" class="col-md-3 col-form-label"> Форматы </label>
                    <div class="col-md-9">
                        <ng-select
                                id="deletePostFormat"
                                [items]="formats$ | async"
                                bindLabel="postFormat"
                                bindValue="id"
                                [multiple]="true"
                                [closeOnSelect]="false"
                                [hideSelected]="true"
                                placeholder="Выберите форматы для удаления"
                                formControlName="deletePostFormat"
                                [ngClass]="{ 'is-invalid': submitted && dff.deletePostFormat.errors }"
                        ></ng-select>
                        <div *ngIf="submitted && dff.deletePostFormat.errors" class="invalid-feedback">
                            <span *ngIf="dff.deletePostFormat.errors.required"></span>
                        </div>
                    </div>
                </div>

                <div class="text-right">
                    <button type="submit" class="btn btn-success">Сохранить</button>
                    <button type="button" class="btn btn-danger ml-1" (click)="modal('close click')">Отменить</button>
                </div>
            </form>
        </div>
    </div>
</ng-template>

<!-- Edit contractor modal  -->
<ng-template #editModal role="document" let-modal="close">
    <div class="modal-header bg-dark update-contractor">
        <h4 class="modal-title text-white">Обновить контрагента</h4>
        <button
                type="button"
                class="close text-white"
                aria-label="Close"
                id="editContractorModal"
                (click)="modal('Cross click')"
        >
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body p-3">
        <div class="text-left">
            <form (ngSubmit)="submitEditForm()" [formGroup]="updateForm">
                <div class="form-group">
                    <label for="updateEditorName">Название редакции</label>
                    <input
                            type="text"
                            formControlName="updateEditorName"
                            class="form-control"
                            [ngClass]="{ 'is-invalid': submitted && uf.updateEditorName.errors }"
                            id="updateEditorName"
                            placeholder="Введите название редакции"
                    />

                    <div *ngIf="submitted && uf.updateEditorName.errors" class="invalid-feedback">
                        <div *ngIf="uf.updateEditorName.errors.required">Название редакции обязательно</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="updateContactPerson">Контактное лицо</label>
                    <input
                            type="text"
                            formControlName="updateContactPerson"
                            class="form-control"
                            [ngClass]="{ 'is-invalid': submitted && uf.updateContactPerson.errors }"
                            id="updateContactPerson"
                            placeholder="Введите контактное лицо"
                    />

                    <div *ngIf="submitted && uf.updateContactPerson.errors" class="invalid-feedback">
                        <div *ngIf="uf.updateContactPerson.errors.required">Контактное лицо обязательно</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="updatePhoneNumber">Номер телефона</label>
                    <input
                            type="text"
                            formControlName="updatePhoneNumber"
                            class="form-control"
                            id="updatePhoneNumber"
                            [ngClass]="{ 'is-invalid': submitted && uf.updatePhoneNumber.errors }"
                    />
                    <span class="font-13 text-muted">e.g "380992314525"</span>
                    <div *ngIf="submitted && uf.updatePhoneNumber.errors" class="invalid-feedback">
                        <div *ngIf="uf.updatePhoneNumber.errors.pattern">Введите корректный номер</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="updateEmail">Email</label>
                    <input
                            class="form-control"
                            id="updateEmail"
                            [ngClass]="{ 'is-invalid': submitted && uf.updateEmail.errors }"
                            placeholder="Введите email"
                            formControlName="updateEmail"
                    />
                    <div *ngIf="submitted && uf.updateEmail.errors" class="invalid-feedback">
                        <div *ngIf="uf.updateEmail.errors.required">Введите email</div>
                        <div *ngIf="uf.updateEmail.errors.pattern">Введите корректный email</div>
                    </div>
                </div>

                <div class="text-right">
                    <button type="submit" *ngIf="!editCheckedMode" class="btn btn-success">Обновить</button>
                    <button type="submit" *ngIf="editCheckedMode" class="btn btn-success">Обновить выбранные</button>
                    <button type="button" class="btn btn-danger ml-1" (click)="modal('close click')">Отменить</button>
                </div>
            </form>
        </div>
    </div>
</ng-template>
