<div class="container-fluid">
    <app-page-title title="Проекты" [breadcrumbItems]="breadCrumbItems"></app-page-title>

    <div class="row mb-2">
        <div class="col-sm-4">
            <button type="button" (click)="openModal(addNewProjectModal)" class="btn btn-danger btn-rounded mb-3">
                <i class="mdi mdi-plus"></i>
                Создать проект
            </button>
        </div>
        <div class="col-sm-8">
            <div class="text-sm-right">
                <div class="btn-group mb-3">
                    <button type="button" (click)="order = null" class="btn btn-primary">Все</button>
                </div>
                <div class="btn-group mb-3 ml-1">
                    <button type="button" (click)="order = orders.confirmed" class="btn btn-light">Подтвержденные
                    </button>
                    <button type="button" (click)="order = orders.notconfirmed" class="btn btn-light">На согласовании
                    </button>
                </div>
            </div>
        </div>
        <!-- end col-->
    </div>
    <!-- end row-->

    <div class="row">
        <app-ui-preloader [display]="loading$ | async"></app-ui-preloader>

        <div class="col-xl-4" *ngFor="let project of projects$ | async; index as index">
            <div class="card-box project-box">
                <div class="dropdown float-right" ngbDropdown>
                    <a
                            href="javascript: void(0);"
                            class="dropdown-toggle card-drop arrow-none"
                            ngbDropdownToggle
                            aria-expanded="false"
                    >
                        <i class="mdi mdi-dots-vertical m-0 text-muted h3"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" ngbDropdownMenu>
                        <a class="dropdown-item" (click)="onChange(project?.id); openModal(editProjectModal);"
                           href="javascript: void(0);">Изменить</a>
                        <a class="dropdown-item" (click)="onDelete(project?.id)"
                           href="javascript: void(0);">Удалить</a>
                    </div>
                </div>
                <!-- Title-->
                <h4 class="mt-0">
                    <a href="javascript: void(0);" class="text-dark">{{ project?.name }}</a>
                </h4>
                <p class="text-muted text-uppercase">
                    <span>Менеджер проекта </span> <i class="mdi mdi-account-circle"></i>
                    <small>{{ project?.manager?.firstName }} {{ project?.manager?.lastName }}</small>
                </p>
                <!-- Desc-->
                <p class="text-muted font-13 mb-3 sp-line-2">
                    {{ project?.client }}
                </p>
                <!-- Task info-->

                <button type="button" class="btn btn-sm btn-blue waves-effect waves-light float-right">
                    <i class="mdi mdi-eye-circle"></i> Посмотреть
                </button>
                <p class="mb-1">
          <span class="pr-2 text-nowrap mb-2 d-inline-block">
            <i class="mdi mdi-format-list-bulleted-type text-muted"></i>
            <b> {{ project?.hashtags?.length }}</b> Хештеги
          </span>
                    <span class="text-nowrap mb-2 d-inline-block">
            <i class="mdi mdi-comment-multiple-outline text-muted"></i>
            <b> {{ project?.contractors?.length }}</b> Контрагенты
          </span>
                </p>
            </div>
            <!-- end card box-->
        </div>
        <!-- end col-->
    </div>
</div>

<!-- Add new project modal  -->
<ng-template #addNewProjectModal role="document" let-modal="close">
    <div class="modal-header bg-dark">
        <h4 class="modal-title text-white">Добавить новый проект</h4>
        <button
                type="button"
                class="close text-white"
                aria-label="Close"
                id="addNewFormatModal"
                (click)="modal('Cross click')"
        >
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body p-3">
        <div class="text-left">
            <form (ngSubmit)="addNewProject()" [formGroup]="createProjectForm">
                <div class="form-group">
                    <label for="name"> Название </label>
                    <input type="text"
                           formControlName="name"
                           class="form-control"
                           [ngClass]="{ 'is-invalid': submitted && createProjectFormControls.name.errors }"
                           id="name"
                           placeholder="Введите название проекта"
                    />

                    <div *ngIf="submitted && createProjectFormControls.name.errors" class="invalid-feedback">
                        <div *ngIf="createProjectFormControls.name.errors.required">Название проекта обязательно</div>
                    </div>
                </div>

                <div class="form-group">
                    <fieldset class="form-group">
                        <label for="projectManager"> Менджер проекта </label>
                        <ng-select
                                id="projectManager"
                                [items]="users$ | async"
                                bindLabel="email"
                                bindValue="id"
                                required
                                [closeOnSelect]="true"
                                [hideSelected]="true"
                                placeholder="Выберите менеджера проекта"
                                formControlName="managerId"
                                [ngClass]="{ 'is-invalid': submitted && createProjectFormControls.managerId.errors }"
                        ></ng-select>
                        <div *ngIf="submitted && createProjectFormControls.managerId.errors" style="display: block" class="invalid-feedback">
                            <span *ngIf="createProjectFormControls.managerId.errors.required">Менеджер проекта обязателен</span>
                        </div>
                    </fieldset>
                </div>

                <div class="form-group">
                    <label for="hashtags"> Хештеги </label>

                    <ng-select
                            id="hashtags"
                            [items]="hashtags$ | async"
                            bindLabel="name"
                            required
                            [multiple]="true"
                            [closeOnSelect]="false"
                            [hideSelected]="true"
                            placeholder="Выберите ключевые слова"
                            formControlName="hashtags"
                            [ngClass]="{ 'is-invalid': submitted && createProjectFormControls.hashtags.errors }"
                    ></ng-select>
                    <div *ngIf="submitted && createProjectFormControls.hashtags.errors" style="display: block" class="invalid-feedback">
                        <span *ngIf="createProjectFormControls.hashtags.errors.required">Хештеги обязательны</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="contractors"> Котрагенты </label>
                    <ng-select
                            id="contractors"
                            [items]="contractors$ | async"
                            bindLabel="editorName"
                            [multiple]="true"
                            [closeOnSelect]="false"
                            required
                            [hideSelected]="true"
                            placeholder="Выберите контрагентов"
                            formControlName="contractors"
                            [ngClass]="{ 'is-invalid': submitted && createProjectFormControls.contractors.errors }"
                    >
                    </ng-select>
                    <div *ngIf="submitted && createProjectFormControls.contractors.errors" style="display: block" class="invalid-feedback">
                        <span *ngIf="createProjectFormControls.contractors.errors.required">Контрагенты обязательны</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="budget"> Бюджет разгона </label>
                    <input type="number"
                           id="budget"
                           min="0"
                           formControlName="budget"
                           required
                           class="form-control"
                           placeholder="Введите бюджет"
                           [ngClass]="{ 'is-invalid': submitted && createProjectFormControls.budget.errors }"
                    />
                    <div *ngIf="submitted && createProjectFormControls.budget.errors" class="invalid-feedback">
                        <span *ngIf="createProjectFormControls.budget.errors.required">Бюджет обязателен</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="contractors"> Почты </label>
                    <ng-select
                            id="emails"
                            [items]="emails$ | async"
                            bindLabel="email"
                            [multiple]="true"
                            required
                            [closeOnSelect]="false"
                            [hideSelected]="true"
                            placeholder="Выберите почты"
                            formControlName="emails"
                            [ngClass]="{ 'is-invalid': submitted && createProjectFormControls.emails.errors }"
                    >
                    </ng-select>
                    <div *ngIf="submitted && createProjectFormControls.emails.errors" style="display: block" class="invalid-feedback">
                        <span *ngIf="createProjectFormControls.emails.errors.required">Почты обязательны</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="client"> Клиент </label>
                    <input type="text"
                           formControlName="client"
                           class="form-control"
                           [ngClass]="{ 'is-invalid': submitted && createProjectFormControls.client.errors }"
                           id="client"
                           required
                           placeholder="Введите клиента"
                    />
                    <div *ngIf="submitted && createProjectFormControls.client.errors" class="invalid-feedback">
                        <div *ngIf="createProjectFormControls.client.errors.required">Поле клиент обязательно</div>
                    </div>
                </div>

                <div class="text-right">
                    <button type="submit" class="btn btn-success">Сохранить</button>
                    <button type="button" class="btn btn-danger ml-1" (click)="modal('close click')">Отменить</button>
                </div>
            </form>
        </div>
    </div>
</ng-template>


<!-- Edit project modal  -->
<ng-template #editProjectModal role="document" let-modal="close">
    <div class="modal-header bg-dark">
        <h4 class="modal-title text-white">Изменить проект</h4>
        <button
                type="button"
                class="close text-white"
                aria-label="Close"
                id="editProjectModal"
                (click)="modal('Cross click')"
        >
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body p-3">
        <div class="text-left">
            <form (ngSubmit)="editProject()" [formGroup]="editProjectForm">
                <div class="form-group">
                    <label for="editName"> Название </label>
                    <input type="text"
                           formControlName="name"
                           class="form-control"
                           [ngClass]="{ 'is-invalid': submitted && editProjectFormControls.name.errors }"
                           id="editName"
                           placeholder="Введите название проекта"
                    />

                    <div *ngIf="submitted && editProjectFormControls.name.errors" class="invalid-feedback">
                        <div *ngIf="editProjectFormControls.name.errors.required">Название проекта обязательно</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="manager"> Менджер проекта </label>
                    <ng-select
                            id="manager"
                            [items]="users$ | async"
                            bindLabel="email"
                            bindValue="id"
                            [closeOnSelect]="true"
                            [hideSelected]="true"
                            placeholder="Выберите менеджера проекта"
                            formControlName="managerId"
                            [ngClass]="{ 'is-invalid': submitted && editProjectFormControls.managerId.errors }"
                    ></ng-select>
                    <div *ngIf="submitted && editProjectFormControls.managerId.errors" style="display: block" class="invalid-feedback">
                        <span *ngIf="editProjectFormControls.managerId.errors.required">Менеджер проекта обязателен</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectHashtags"> Хештеги </label>

                    <ng-select
                            id="projectHashtags"
                            [items]="hashtags$ | async"
                            bindLabel="name"
                            [multiple]="true"
                            [closeOnSelect]="false"
                            [hideSelected]="true"
                            placeholder="Выберите ключевые слова"
                            formControlName="hashtags"
                            [ngClass]="{ 'is-invalid': submitted && editProjectFormControls.hashtags.errors }"
                    ></ng-select>
                    <div *ngIf="submitted && editProjectFormControls.hashtags.errors" style="display: block" class="invalid-feedback">
                        <span *ngIf="editProjectFormControls.hashtags.errors.required">Хештеги обязательны</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectContractors"> Котрагенты </label>
                    <ng-select
                            id="projectContractors"
                            [items]="contractors$ | async"
                            bindLabel="editorName"
                            [multiple]="true"
                            [closeOnSelect]="false"
                            [hideSelected]="true"
                            placeholder="Выберите контрагентов"
                            formControlName="contractors"
                            [ngClass]="{ 'is-invalid': submitted && editProjectFormControls.contractors.errors }"
                    >
                    </ng-select>
                    <div *ngIf="submitted && editProjectFormControls.contractors.errors" style="display: block" class="invalid-feedback">
                        <span *ngIf="editProjectFormControls.contractors.errors.required">Контрагенты обязательны</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectBudget"> Бюджет разгона </label>

                    <input type="number"
                           min="0"
                           id="projectBudget"
                           formControlName="budget"
                           class="form-control"
                           placeholder="Введите бюджет"
                           [ngClass]="{ 'is-invalid': submitted && editProjectFormControls.budget.errors }"
                    />
                    <div *ngIf="submitted && editProjectFormControls.budget.errors" class="invalid-feedback">
                        <span *ngIf="editProjectFormControls.budget.errors.required"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectEmails"> Почты </label>
                    <ng-select
                            id="projectEmails"
                            [items]="emails$ | async"
                            bindLabel="email"
                            [multiple]="true"
                            [closeOnSelect]="false"
                            [hideSelected]="true"
                            placeholder="Выберите почты"
                            formControlName="emails"
                            [ngClass]="{ 'is-invalid': submitted && editProjectFormControls.emails.errors }"
                    >
                    </ng-select>
                    <div *ngIf="submitted && editProjectFormControls.emails.errors" style="display: block" class="invalid-feedback">
                        <span *ngIf="editProjectFormControls.emails.errors.required">Почты обязательны</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectClient"> Клиент </label>
                    <input type="text"
                           formControlName="client"
                           class="form-control"
                           [ngClass]="{ 'is-invalid': submitted && editProjectFormControls.client.errors }"
                           id="projectClient"
                           placeholder="Введите клиента"
                    />

                    <div *ngIf="submitted && editProjectFormControls.client.errors" class="invalid-feedback">
                        <div *ngIf="editProjectFormControls.client.errors.required">Поле клиент обязательно</div>
                    </div>
                </div>

                <div class="text-right">
                    <button type="submit" class="btn btn-success">Сохранить</button>
                    <button type="button" class="btn btn-danger ml-1" (click)="modal('close click')">Отменить</button>
                </div>
            </form>
        </div>
    </div>
</ng-template>
